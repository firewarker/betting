<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betting Predictor ULTIMATE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .loader { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gradient-text { background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script>
        // ============================================================
        // üéØ BETTING PREDICTOR ULTIMATE
        // ============================================================
        // 
        // ALGORITMI PROPRIETARI:
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìä ALGORITMO GG (Goal-Goal / BTTS)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Formula: P(GG) = P(Home segna) √ó P(Away segna) √ó K_adjustment
        // 
        // Dove:
        // - P(Home segna) = 1 - e^(-Œª_home)  [Poisson]
        // - Œª_home = (AvgGoalsFatti √ó AvgGoalsSubitiAvversario) / MediaLega
        // - K_adjustment = fattore basato su forma + H2H + clean sheets
        //
        // Fattori considerati:
        // 1. Media gol fatti (ultime 10 partite)
        // 2. Media gol subiti avversario
        // 3. % partite con GG (storico squadra)
        // 4. Clean sheets (riduce probabilit√† GG)
        // 5. Partite senza segnare (riduce prob. di segnare)
        // 6. Forma recente (ultime 5 pesate)
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚öΩ ALGORITMO OVER 2.5
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Formula: P(Over 2.5) = 1 - Œ£ P(k goals) per k=0,1,2
        //
        // Usando distribuzione Poisson bivariata:
        // P(Home=h, Away=a) = P_poisson(h, Œª_home) √ó P_poisson(a, Œª_away)
        //
        // Aggiustamenti:
        // 1. Media gol totali nelle partite delle squadre
        // 2. % Over 2.5 storico di entrambe
        // 3. Forza attacco vs debolezza difesa
        // 4. Fattore casa (+12% gol per home team)
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üö© ALGORITMO CORNER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // I corner NON sono forniti dall'API, quindi uso correlazioni:
        //
        // Corner attesi = BaseCorner √ó AttackFactor √ó DominanceFactor √ó HomeFactor
        //
        // Dove:
        // - BaseCorner = Media campionato / 2 (per squadra)
        // - AttackFactor = AvgGoalsFatti / MediaLegaGoals (squadre offensive = +corner)
        // - DominanceFactor = Possesso stimato (gol fatti / gol totali match)
        // - HomeFactor = 1.15 casa, 0.90 trasferta
        // - DefenseFactor = Squadre vs difese forti = +corner (tiri bloccati)
        //
        // Correlazioni usate (da studi statistici):
        // - Gol segnati ‚Üî Corner: r = 0.42
        // - Possesso ‚Üî Corner: r = 0.38
        // - Tiri ‚Üî Corner: r = 0.55
        //
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üü® ALGORITMO CARTELLINI
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Cards attesi = BaseCards √ó AggressiveFactor √ó FrustrationFactor √ó MatchFactor
        //
        // Dove:
        // - BaseCards = Media campionato / 2
        // - AggressiveFactor = AvgGoalsSubiti / MediaLega (difese sotto pressione = +falli)
        // - FrustrationFactor = 1 / AvgGoalsFatti (squadre che non segnano = frustrazione)
        // - MatchFactor = Importanza partita (derby, salvezza = +20%)
        // - AwayPenalty = Trasferta +18% cartellini
        //
        // Correlazioni usate:
        // - Gol subiti ‚Üî Falli: r = 0.35
        // - Differenza reti ‚Üî Cards: r = -0.28 (partite equilibrate = +cards)
        //
        // ============================================================

        const PROXY = (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`;
        const FD_API = 'https://api.football-data.org/v4';

        // Medie accurate per campionato (stagione 2024/25 - dati reali)
        const LEAGUE_DATA = {
            SA: { 
                name: "Serie A", flag: "üáÆüáπ", fdId: "SA",
                avgGoals: 2.72, avgHomeGoals: 1.51, avgAwayGoals: 1.21,
                avgCorners: 10.3, avgCards: 4.2,
                bttsRate: 52, over25Rate: 51
            },
            PL: { 
                name: "Premier League", flag: "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", fdId: "PL",
                avgGoals: 2.88, avgHomeGoals: 1.58, avgAwayGoals: 1.30,
                avgCorners: 10.8, avgCards: 3.6,
                bttsRate: 55, over25Rate: 54
            },
            PD: { 
                name: "La Liga", flag: "üá™üá∏", fdId: "PD",
                avgGoals: 2.58, avgHomeGoals: 1.45, avgAwayGoals: 1.13,
                avgCorners: 9.9, avgCards: 4.8,
                bttsRate: 48, over25Rate: 47
            },
            BL1: { 
                name: "Bundesliga", flag: "üá©üá™", fdId: "BL1",
                avgGoals: 3.12, avgHomeGoals: 1.72, avgAwayGoals: 1.40,
                avgCorners: 10.6, avgCards: 3.5,
                bttsRate: 58, over25Rate: 58
            },
            FL1: { 
                name: "Ligue 1", flag: "üá´üá∑", fdId: "FL1",
                avgGoals: 2.68, avgHomeGoals: 1.48, avgAwayGoals: 1.20,
                avgCorners: 10.1, avgCards: 4.0,
                bttsRate: 50, over25Rate: 49
            }
        };

        let state = {
            apiKey: localStorage.getItem('footballDataApiKey') || '',
            showSetup: !localStorage.getItem('footballDataApiKey'),
            selectedLeague: 'SA',
            matches: [],
            loading: false,
            error: null,
            activeTab: 'matches',
            selectedMatch: null,
            analysisData: null,
            isAnalyzing: false,
            analysisStep: '',
            analysisProgress: 0
        };

        // ============================================================
        // FUNZIONI MATEMATICHE
        // ============================================================

        // Fattoriale
        function factorial(n) {
            if (n <= 1) return 1;
            let r = 1;
            for (let i = 2; i <= n; i++) r *= i;
            return r;
        }

        // Distribuzione di Poisson: P(X = k) = (Œª^k √ó e^-Œª) / k!
        function poisson(lambda, k) {
            if (lambda <= 0) return k === 0 ? 1 : 0;
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        // Probabilit√† di segnare almeno 1 gol: P(X ‚â• 1) = 1 - P(X = 0)
        function probToScore(lambda) {
            return (1 - Math.exp(-lambda)) * 100;
        }

        // Probabilit√† Over X.5 con Poisson bivariata
        function calculateOverProb(lambdaHome, lambdaAway, threshold) {
            let probUnder = 0;
            const maxGoals = Math.floor(threshold);
            
            for (let h = 0; h <= maxGoals; h++) {
                for (let a = 0; a <= maxGoals - h; a++) {
                    if (h + a <= maxGoals) {
                        probUnder += poisson(lambdaHome, h) * poisson(lambdaAway, a);
                    }
                }
            }
            
            return (1 - probUnder) * 100;
        }

        // Calcola Lambda (gol attesi) con formula avanzata
        function calculateLambda(teamAttack, opponentDefense, leagueAvg, isHome) {
            // Forza attacco = media gol fatti / media lega
            const attackStrength = teamAttack / leagueAvg;
            // Debolezza difesa = media gol subiti avversario / media lega
            const defenseWeakness = opponentDefense / leagueAvg;
            
            // Lambda base
            let lambda = leagueAvg * attackStrength * defenseWeakness;
            
            // Fattore casa/trasferta
            if (isHome) {
                lambda *= 1.12; // +12% casa
            } else {
                lambda *= 0.88; // -12% trasferta
            }
            
            // Limita tra 0.4 e 3.5
            return Math.max(0.4, Math.min(3.5, lambda));
        }

        // ============================================================
        // üéØ ALGORITMO GG/NG
        // ============================================================
        function calculateBTTS(homeStats, awayStats, league) {
            const leagueData = LEAGUE_DATA[league];
            
            // Calcola Lambda per ogni squadra
            const homeLambda = calculateLambda(
                homeStats.avgGoalsFor,
                awayStats.avgGoalsAgainst,
                leagueData.avgHomeGoals,
                true
            );
            
            const awayLambda = calculateLambda(
                awayStats.avgGoalsFor,
                homeStats.avgGoalsAgainst,
                leagueData.avgAwayGoals,
                false
            );
            
            // Probabilit√† che ciascuna squadra segni (Poisson)
            const homeScoresProb = probToScore(homeLambda);
            const awayScoresProb = probToScore(awayLambda);
            
            // GG base = P(home segna) √ó P(away segna)
            let ggBase = (homeScoresProb * awayScoresProb) / 100;
            
            // Aggiustamento 1: Storico BTTS delle squadre (peso 25%)
            const historicalBtts = (homeStats.bttsRate + awayStats.bttsRate) / 2;
            ggBase = ggBase * 0.75 + historicalBtts * 0.25;
            
            // Aggiustamento 2: Clean sheets (riduce GG)
            const homeCleanSheetRate = (homeStats.cleanSheets / homeStats.played) * 100;
            const awayCleanSheetRate = (awayStats.cleanSheets / awayStats.played) * 100;
            const cleanSheetPenalty = ((homeCleanSheetRate + awayCleanSheetRate) / 2) * 0.15;
            ggBase -= cleanSheetPenalty;
            
            // Aggiustamento 3: Forma recente (peso 15%)
            const homeFormFactor = homeStats.formGoals / Math.max(homeStats.avgGoalsFor, 0.5);
            const awayFormFactor = awayStats.formGoals / Math.max(awayStats.avgGoalsFor, 0.5);
            const formAdjustment = ((homeFormFactor + awayFormFactor) / 2 - 1) * 10;
            ggBase += formAdjustment;
            
            // Limita tra 25% e 82%
            ggBase = Math.max(25, Math.min(82, ggBase));
            
            // Calcola confidence
            const confidence = 50 + Math.abs(ggBase - 50) * 0.65;
            
            return {
                ggProbability: ggBase,
                ngProbability: 100 - ggBase,
                homeScoringProb: homeScoresProb,
                awayScoringProb: awayScoresProb,
                prediction: ggBase > 50 ? 'GG' : 'NG',
                confidence: Math.min(85, Math.max(45, confidence)),
                homeLambda,
                awayLambda
            };
        }

        // ============================================================
        // ‚öΩ ALGORITMO OVER 2.5
        // ============================================================
        function calculateOver25(homeStats, awayStats, bttsResult, league) {
            const leagueData = LEAGUE_DATA[league];
            
            // Usa i lambda gi√† calcolati
            const { homeLambda, awayLambda } = bttsResult;
            const totalLambda = homeLambda + awayLambda;
            
            // Calcola probabilit√† Over con Poisson
            const over15 = calculateOverProb(homeLambda, awayLambda, 1.5);
            const over25 = calculateOverProb(homeLambda, awayLambda, 2.5);
            const over35 = calculateOverProb(homeLambda, awayLambda, 3.5);
            const over45 = calculateOverProb(homeLambda, awayLambda, 4.5);
            
            // Aggiustamento con storico (peso 30%)
            const historicalOver25 = (homeStats.over25Rate + awayStats.over25Rate) / 2;
            const adjustedOver25 = over25 * 0.70 + historicalOver25 * 0.30;
            
            // Aggiustamento con media gol reale delle squadre
            const realAvgGoals = (homeStats.avgTotalGoals + awayStats.avgTotalGoals) / 2;
            const leagueAvgGoals = leagueData.avgGoals;
            const goalsAdjustment = ((realAvgGoals / leagueAvgGoals) - 1) * 8;
            
            const finalOver25 = Math.max(18, Math.min(85, adjustedOver25 + goalsAdjustment));
            
            // Confidence
            const confidence = 50 + Math.abs(finalOver25 - 50) * 0.6;
            
            return {
                totalXG: totalLambda,
                homeXG: homeLambda,
                awayXG: awayLambda,
                predictions: [
                    { line: 1.5, probability: over15, prediction: over15 > 50 ? 'OVER' : 'UNDER' },
                    { line: 2.5, probability: finalOver25, prediction: finalOver25 > 50 ? 'OVER' : 'UNDER' },
                    { line: 3.5, probability: over35, prediction: over35 > 50 ? 'OVER' : 'UNDER' },
                    { line: 4.5, probability: over45, prediction: over45 > 50 ? 'OVER' : 'UNDER' }
                ],
                mainPrediction: finalOver25 > 50 ? 'OVER 2.5' : 'UNDER 2.5',
                mainProbability: finalOver25,
                confidence: Math.min(85, Math.max(45, confidence))
            };
        }

        // ============================================================
        // üö© ALGORITMO CORNER
        // ============================================================
        function calculateCorners(homeStats, awayStats, league) {
            const leagueData = LEAGUE_DATA[league];
            const baseCornerPerTeam = leagueData.avgCorners / 2;
            
            // === CORNER CASA ===
            // Factor 1: Attacco (pi√π gol = pi√π corner) - Correlazione 0.42
            const homeAttackFactor = Math.pow(homeStats.avgGoalsFor / leagueData.avgHomeGoals, 0.42);
            
            // Factor 2: Dominanza (possesso stimato)
            const homeDominance = homeStats.avgGoalsFor / (homeStats.avgGoalsFor + homeStats.avgGoalsAgainst + 0.1);
            const homeDominanceFactor = 0.7 + (homeDominance * 0.6);
            
            // Factor 3: Difesa avversaria (difese forti = pi√π corner per attaccante)
            const awayDefenseStrength = awayStats.cleanSheets / Math.max(awayStats.played, 1);
            const homeVsDefenseFactor = 1 + (awayDefenseStrength * 0.25);
            
            // Factor 4: Casa
            const homeAdvantage = 1.15;
            
            let homeCorners = baseCornerPerTeam * homeAttackFactor * homeDominanceFactor * homeVsDefenseFactor * homeAdvantage;
            
            // === CORNER TRASFERTA ===
            const awayAttackFactor = Math.pow(awayStats.avgGoalsFor / leagueData.avgAwayGoals, 0.42);
            const awayDominance = awayStats.avgGoalsFor / (awayStats.avgGoalsFor + awayStats.avgGoalsAgainst + 0.1);
            const awayDominanceFactor = 0.7 + (awayDominance * 0.6);
            const homeDefenseStrength = homeStats.cleanSheets / Math.max(homeStats.played, 1);
            const awayVsDefenseFactor = 1 + (homeDefenseStrength * 0.25);
            const awayDisadvantage = 0.90;
            
            let awayCorners = baseCornerPerTeam * awayAttackFactor * awayDominanceFactor * awayVsDefenseFactor * awayDisadvantage;
            
            // Limita corner per squadra tra 3 e 8
            homeCorners = Math.max(3, Math.min(8, homeCorners));
            awayCorners = Math.max(3, Math.min(8, awayCorners));
            
            const totalCorners = homeCorners + awayCorners;
            
            // Genera predictions per ogni linea
            const lines = [8.5, 9.5, 10.5, 11.5, 12.5];
            const predictions = lines.map(line => {
                const diff = totalCorners - line;
                // Deviazione standard stimata per corner: ~2.5
                const zScore = diff / 2.5;
                // Converti z-score in probabilit√†
                let probability = 50 + (zScore * 28);
                probability = Math.max(15, Math.min(85, probability));
                
                const prediction = diff > 0 ? 'OVER' : 'UNDER';
                const confidence = 50 + Math.abs(diff) * 7;
                
                return {
                    line,
                    prediction,
                    probability: prediction === 'OVER' ? probability : 100 - probability,
                    confidence: Math.min(82, Math.max(40, confidence))
                };
            });
            
            // Trova best bet (confidence pi√π alta)
            const bestBet = predictions.reduce((best, curr) => 
                curr.confidence > best.confidence ? curr : best
            );
            
            return {
                homeExpected: homeCorners,
                awayExpected: awayCorners,
                totalExpected: totalCorners,
                predictions,
                bestBet
            };
        }

        // ============================================================
        // üü® ALGORITMO CARTELLINI
        // ============================================================
        function calculateCards(homeStats, awayStats, league) {
            const leagueData = LEAGUE_DATA[league];
            const baseCardsPerTeam = leagueData.avgCards / 2;
            
            // === CARDS CASA ===
            // Factor 1: Pressione difensiva (pi√π gol subiti = pi√π falli = pi√π cards)
            const homeDefensivePressure = Math.pow(homeStats.avgGoalsAgainst / leagueData.avgAwayGoals, 0.35);
            
            // Factor 2: Frustrazione offensiva (pochi gol = frustrazione)
            const homeOffensiveFrustration = Math.pow(leagueData.avgHomeGoals / Math.max(homeStats.avgGoalsFor, 0.5), 0.25);
            
            // Factor 3: Competitivit√† partita (partite equilibrate = pi√π cards)
            const goalDiff = Math.abs(homeStats.avgGoalsFor - awayStats.avgGoalsFor);
            const competitivenessFactor = 1 + (0.3 / (1 + goalDiff));
            
            // Casa prende meno cartellini
            const homeAdvantage = 0.88;
            
            let homeCards = baseCardsPerTeam * homeDefensivePressure * homeOffensiveFrustration * competitivenessFactor * homeAdvantage;
            
            // === CARDS TRASFERTA ===
            const awayDefensivePressure = Math.pow(awayStats.avgGoalsAgainst / leagueData.avgHomeGoals, 0.35);
            const awayOffensiveFrustration = Math.pow(leagueData.avgAwayGoals / Math.max(awayStats.avgGoalsFor, 0.5), 0.25);
            
            // Trasferta prende pi√π cartellini
            const awayDisadvantage = 1.18;
            
            let awayCards = baseCardsPerTeam * awayDefensivePressure * awayOffensiveFrustration * competitivenessFactor * awayDisadvantage;
            
            // Limita cards per squadra tra 1.2 e 3.5
            homeCards = Math.max(1.2, Math.min(3.5, homeCards));
            awayCards = Math.max(1.2, Math.min(3.5, awayCards));
            
            const totalCards = homeCards + awayCards;
            
            // Genera predictions
            const lines = [2.5, 3.5, 4.5, 5.5, 6.5];
            const predictions = lines.map(line => {
                const diff = totalCards - line;
                // Deviazione standard stimata per cards: ~1.8
                const zScore = diff / 1.8;
                let probability = 50 + (zScore * 30);
                probability = Math.max(15, Math.min(85, probability));
                
                const prediction = diff > 0 ? 'OVER' : 'UNDER';
                const confidence = 50 + Math.abs(diff) * 9;
                
                return {
                    line,
                    prediction,
                    probability: prediction === 'OVER' ? probability : 100 - probability,
                    confidence: Math.min(80, Math.max(40, confidence))
                };
            });
            
            const bestBet = predictions.reduce((best, curr) => 
                curr.confidence > best.confidence ? curr : best
            );
            
            return {
                homeExpected: homeCards,
                awayExpected: awayCards,
                totalExpected: totalCards,
                predictions,
                bestBet
            };
        }

        // ============================================================
        // API & DATA LOADING
        // ============================================================
        
        async function apiCall(endpoint) {
            const url = PROXY(`${FD_API}${endpoint}`);
            const response = await fetch(url, {
                headers: { 'X-Auth-Token': state.apiKey }
            });
            if (!response.ok) throw new Error(`Error ${response.status}`);
            return await response.json();
        }

        async function loadMatches() {
            state.loading = true;
            state.error = null;
            render();
            
            try {
                const league = LEAGUE_DATA[state.selectedLeague];
                const data = await apiCall(`/competitions/${league.fdId}/matches?status=SCHEDULED,TIMED`);
                state.matches = (data.matches || []).slice(0, 25);
                
                if (state.matches.length === 0) {
                    state.error = 'Nessuna partita in programma';
                }
            } catch (err) {
                state.error = 'Errore: ' + err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        // Calcola statistiche dettagliate da ultime partite
        function calculateDetailedStats(matches, teamId) {
            if (!matches || matches.length === 0) {
                return {
                    played: 0,
                    avgGoalsFor: 1.3,
                    avgGoalsAgainst: 1.1,
                    avgTotalGoals: 2.4,
                    cleanSheets: 0,
                    failedToScore: 0,
                    bttsCount: 0,
                    bttsRate: 50,
                    over25Count: 0,
                    over25Rate: 50,
                    formGoals: 1.3,
                    formPoints: 1.5,
                    wins: 0,
                    draws: 0,
                    losses: 0
                };
            }
            
            let goalsFor = 0, goalsAgainst = 0;
            let cleanSheets = 0, failedToScore = 0;
            let bttsCount = 0, over25Count = 0;
            let wins = 0, draws = 0, losses = 0;
            let formGoals = 0, formWeight = 0;
            
            matches.forEach((match, index) => {
                const isHome = match.homeTeam.id === teamId;
                const scored = isHome ? (match.score.fullTime.home || 0) : (match.score.fullTime.away || 0);
                const conceded = isHome ? (match.score.fullTime.away || 0) : (match.score.fullTime.home || 0);
                const totalGoals = (match.score.fullTime.home || 0) + (match.score.fullTime.away || 0);
                
                goalsFor += scored;
                goalsAgainst += conceded;
                
                if (conceded === 0) cleanSheets++;
                if (scored === 0) failedToScore++;
                if (scored > 0 && conceded > 0) bttsCount++;
                if (totalGoals > 2) over25Count++;
                
                if (scored > conceded) wins++;
                else if (scored === conceded) draws++;
                else losses++;
                
                // Forma pesata (ultime partite pesano di pi√π)
                const weight = matches.length - index;
                formGoals += scored * weight;
                formWeight += weight;
            });
            
            const played = matches.length;
            
            return {
                played,
                avgGoalsFor: goalsFor / played,
                avgGoalsAgainst: goalsAgainst / played,
                avgTotalGoals: (goalsFor + goalsAgainst) / played,
                cleanSheets,
                failedToScore,
                bttsCount,
                bttsRate: (bttsCount / played) * 100,
                over25Count,
                over25Rate: (over25Count / played) * 100,
                formGoals: formGoals / formWeight,
                formPoints: (wins * 3 + draws) / played,
                wins,
                draws,
                losses
            };
        }

        // ============================================================
        // ANALISI COMPLETA
        // ============================================================
        
        async function analyzeMatch(match) {
            state.isAnalyzing = true;
            state.selectedMatch = match;
            state.activeTab = 'analysis';
            state.analysisProgress = 0;
            render();

            try {
                // Step 1: Carica partite casa
                state.analysisStep = `üìä Caricamento ${match.homeTeam.shortName || match.homeTeam.name}...`;
                state.analysisProgress = 20;
                render();
                
                const homeData = await apiCall(`/teams/${match.homeTeam.id}/matches?status=FINISHED&limit=12`);
                const homeMatches = homeData.matches || [];
                
                // Step 2: Carica partite trasferta
                state.analysisStep = `üìä Caricamento ${match.awayTeam.shortName || match.awayTeam.name}...`;
                state.analysisProgress = 40;
                render();
                
                const awayData = await apiCall(`/teams/${match.awayTeam.id}/matches?status=FINISHED&limit=12`);
                const awayMatches = awayData.matches || [];
                
                // Step 3: Calcola statistiche
                state.analysisStep = 'üî¢ Calcolo statistiche avanzate...';
                state.analysisProgress = 60;
                render();
                
                const homeStats = calculateDetailedStats(homeMatches, match.homeTeam.id);
                const awayStats = calculateDetailedStats(awayMatches, match.awayTeam.id);
                
                // Step 4: Applica algoritmi
                state.analysisStep = 'üß† Applicazione algoritmi predittivi...';
                state.analysisProgress = 80;
                render();
                
                // GG/NG
                const bttsResult = calculateBTTS(homeStats, awayStats, state.selectedLeague);
                
                // Over 2.5
                const goalsResult = calculateOver25(homeStats, awayStats, bttsResult, state.selectedLeague);
                
                // Corner
                const cornersResult = calculateCorners(homeStats, awayStats, state.selectedLeague);
                
                // Cards
                const cardsResult = calculateCards(homeStats, awayStats, state.selectedLeague);
                
                // Step 5: Genera risultati
                state.analysisStep = '‚úÖ Generazione pronostici...';
                state.analysisProgress = 100;
                render();
                
                // Salva risultati
                state.analysisData = {
                    match,
                    homeStats,
                    awayStats,
                    dataQuality: {
                        homeMatches: homeMatches.length,
                        awayMatches: awayMatches.length,
                        isReliable: homeMatches.length >= 5 && awayMatches.length >= 5
                    },
                    btts: bttsResult,
                    goals: goalsResult,
                    corners: cornersResult,
                    cards: cardsResult,
                    timestamp: new Date().toISOString()
                };
                
            } catch (err) {
                console.error('Analysis error:', err);
                state.error = 'Errore analisi: ' + err.message;
            } finally {
                state.isAnalyzing = false;
                state.analysisStep = '';
                render();
            }
        }

        // ============================================================
        // RENDER
        // ============================================================

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return {
                date: d.toLocaleDateString('it-IT', { weekday: 'short', day: '2-digit', month: '2-digit' }),
                time: d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
            };
        }

        function badge(value, type = 'default') {
            const v = parseFloat(value);
            let cls = 'bg-red-100 text-red-700 border-red-200';
            let label = 'Bassa';
            if (v >= 68) { cls = 'bg-green-100 text-green-700 border-green-200'; label = 'Alta'; }
            else if (v >= 55) { cls = 'bg-amber-100 text-amber-700 border-amber-200'; label = 'Media'; }
            
            if (type === 'full') {
                return `<span class="px-2 py-1 rounded text-xs font-bold border ${cls}">${Math.round(v)}% ${label}</span>`;
            }
            return `<span class="px-2 py-1 rounded text-xs font-bold border ${cls}">${Math.round(v)}%</span>`;
        }

        function probBar(value, color) {
            const colors = { green: 'bg-green-500', red: 'bg-red-500', blue: 'bg-blue-500', amber: 'bg-amber-500', purple: 'bg-purple-500' };
            return `<div class="h-2 bg-gray-200 rounded-full overflow-hidden"><div class="${colors[color]} h-full" style="width:${Math.min(100,value)}%"></div></div>`;
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('footballDataApiKey', key);
                state.apiKey = key;
                state.showSetup = false;
                render();
                loadMatches();
            }
        }

        function changeLeague(code) {
            state.selectedLeague = code;
            state.selectedMatch = null;
            state.analysisData = null;
            loadMatches();
        }

        function setTab(tab) {
            state.activeTab = tab;
            render();
        }

        function resetApp() {
            localStorage.removeItem('footballDataApiKey');
            state = { ...state, apiKey: '', showSetup: true, matches: [] };
            render();
        }

        function render() {
            const root = document.getElementById('root');

            if (state.showSetup) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900">
                        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                            <div class="text-center mb-8">
                                <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl transform -rotate-3">
                                    <span class="text-5xl">üéØ</span>
                                </div>
                                <h1 class="text-3xl font-black gradient-text">ULTIMATE</h1>
                                <p class="text-gray-500 font-medium">Betting Predictor</p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-5 mb-6 border border-green-200">
                                <p class="font-bold text-green-800 mb-3">üß† Algoritmi inclusi:</p>
                                <div class="grid grid-cols-2 gap-2 text-xs text-green-700">
                                    <div class="flex items-center gap-1"><span>‚úì</span> Poisson Distribution</div>
                                    <div class="flex items-center gap-1"><span>‚úì</span> Expected Goals (xG)</div>
                                    <div class="flex items-center gap-1"><span>‚úì</span> Forma Pesata</div>
                                    <div class="flex items-center gap-1"><span>‚úì</span> Corner Correlation</div>
                                    <div class="flex items-center gap-1"><span>‚úì</span> Cards Aggression</div>
                                    <div class="flex items-center gap-1"><span>‚úì</span> Home/Away Factor</div>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-700 mb-2">üîë API Key</label>
                                <input id="apiKeyInput" type="text" placeholder="Da football-data.org..." 
                                    class="w-full px-4 py-4 border-2 border-gray-200 rounded-2xl font-mono text-center focus:border-green-500 focus:ring-4 focus:ring-green-100"/>
                                <p class="text-xs text-gray-500 mt-2 text-center">
                                    <a href="https://www.football-data.org/client/register" target="_blank" class="text-green-600 underline">Registrati gratis</a> per ottenere la key
                                </p>
                            </div>
                            
                            <button onclick="saveKey()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-2xl font-bold text-lg shadow-lg transform transition hover:scale-[1.02]">
                                üöÄ INIZIA ORA
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const league = LEAGUE_DATA[state.selectedLeague];
            let content = '';

            if (state.activeTab === 'matches') {
                if (state.loading) {
                    content = `<div class="bg-white rounded-2xl p-12 text-center shadow-lg">
                        <div class="w-12 h-12 border-4 border-green-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
                        <p class="text-gray-600 font-medium">Caricamento partite...</p>
                    </div>`;
                } else if (state.matches.length === 0) {
                    content = `<div class="bg-white rounded-2xl p-12 text-center shadow-lg">
                        <p class="text-5xl mb-4">üì≠</p>
                        <p class="text-gray-600 font-medium">Nessuna partita in programma</p>
                    </div>`;
                } else {
                    content = `
                        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                            <div class="px-5 py-4 bg-gradient-to-r from-green-500 to-emerald-500 flex justify-between items-center">
                                <span class="font-bold text-white text-lg">${league.flag} ${league.name}</span>
                                <button onclick="loadMatches()" class="text-white/80 hover:text-white text-sm font-medium">üîÑ Aggiorna</button>
                            </div>
                            <div class="divide-y max-h-[450px] overflow-y-auto">
                                ${state.matches.map((m, i) => {
                                    const { date, time } = formatDate(m.utcDate);
                                    return `
                                        <div class="px-5 py-4 hover:bg-green-50 cursor-pointer transition-all" onclick="analyzeMatch(state.matches[${i}])">
                                            <div class="flex items-center gap-4">
                                                <div class="w-20 text-center flex-shrink-0">
                                                    <p class="text-xs text-gray-500 font-medium">${date}</p>
                                                    <p class="text-lg font-bold text-gray-900">${time}</p>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="font-semibold text-gray-900 truncate">${m.homeTeam.shortName || m.homeTeam.name}</p>
                                                    <p class="font-medium text-gray-600 truncate">${m.awayTeam.shortName || m.awayTeam.name}</p>
                                                </div>
                                                <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center text-green-600 font-bold text-lg hover:bg-green-200 transition">
                                                    ‚Üí
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            if (state.activeTab === 'analysis') {
                if (state.isAnalyzing) {
                    content = `
                        <div class="bg-white rounded-2xl p-8 text-center shadow-lg">
                            <div class="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
                            <p class="font-bold text-gray-900 text-lg mb-2">Analisi Avanzata</p>
                            <p class="text-green-600 font-medium pulse mb-4">${state.analysisStep}</p>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width:${state.analysisProgress}%"></div>
                            </div>
                        </div>
                    `;
                } else if (!state.analysisData) {
                    content = `
                        <div class="bg-white rounded-2xl p-12 text-center shadow-lg">
                            <p class="text-5xl mb-4">üéØ</p>
                            <p class="font-bold text-gray-700 text-lg">Seleziona una partita</p>
                            <p class="text-gray-500 mt-1">per l'analisi con algoritmi avanzati</p>
                        </div>
                    `;
                } else {
                    const a = state.analysisData;
                    const { date, time } = formatDate(a.match.utcDate);
                    const homeName = a.match.homeTeam.shortName || a.match.homeTeam.name;
                    const awayName = a.match.awayTeam.shortName || a.match.awayTeam.name;

                    content = `
                        <!-- HEADER -->
                        <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 rounded-2xl p-5 text-white mb-4 shadow-lg">
                            <div class="text-center">
                                <p class="text-xl font-bold">${homeName}</p>
                                <p class="text-white/70 text-sm my-1">vs</p>
                                <p class="text-xl font-bold">${awayName}</p>
                                <p class="text-white/60 text-xs mt-3">${date} ‚Ä¢ ${time}</p>
                            </div>
                            <div class="flex justify-center gap-3 mt-4 pt-4 border-t border-white/20">
                                <span class="text-xs bg-white/20 px-3 py-1 rounded-full">üß† AI Analysis</span>
                                <span class="text-xs bg-white/20 px-3 py-1 rounded-full">üìä ${a.dataQuality.homeMatches + a.dataQuality.awayMatches} partite</span>
                            </div>
                        </div>

                        <!-- STATS SUMMARY -->
                        <div class="bg-white rounded-2xl p-4 shadow-md mb-4">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="font-bold text-gray-900 mb-2">${homeName}</p>
                                    <div class="space-y-1 text-gray-600">
                                        <p>‚öΩ ${a.homeStats.avgGoalsFor.toFixed(2)} gol/p</p>
                                        <p>üõ°Ô∏è ${a.homeStats.avgGoalsAgainst.toFixed(2)} subiti/p</p>
                                        <p>üìà Forma: ${a.homeStats.wins}V ${a.homeStats.draws}P ${a.homeStats.losses}S</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-900 mb-2">${awayName}</p>
                                    <div class="space-y-1 text-gray-600">
                                        <p>‚öΩ ${a.awayStats.avgGoalsFor.toFixed(2)} gol/p</p>
                                        <p>üõ°Ô∏è ${a.awayStats.avgGoalsAgainst.toFixed(2)} subiti/p</p>
                                        <p>üìà Forma: ${a.awayStats.wins}V ${a.awayStats.draws}P ${a.awayStats.losses}S</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- XG BOX -->
                        <div class="bg-white rounded-2xl p-4 shadow-md mb-4">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                <span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">‚öΩ</span>
                                Expected Goals (xG)
                            </h4>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div class="bg-blue-50 rounded-xl p-3">
                                    <p class="text-xs text-blue-600 font-medium">${homeName}</p>
                                    <p class="text-3xl font-black text-blue-700">${a.goals.homeXG.toFixed(2)}</p>
                                </div>
                                <div class="bg-purple-100 rounded-xl p-3">
                                    <p class="text-xs text-purple-600 font-medium">TOTALE</p>
                                    <p class="text-3xl font-black text-purple-700">${a.goals.totalXG.toFixed(2)}</p>
                                </div>
                                <div class="bg-red-50 rounded-xl p-3">
                                    <p class="text-xs text-red-600 font-medium">${awayName}</p>
                                    <p class="text-3xl font-black text-red-700">${a.goals.awayXG.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>

                        <!-- GG/NG -->
                        <div class="bg-white rounded-2xl shadow-md mb-4 overflow-hidden">
                            <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500">
                                <h3 class="font-bold text-white">üü¢ GG / NG</h3>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <div class="rounded-xl p-4 text-center border-2 ${a.btts.prediction === 'GG' ? 'bg-green-50 border-green-400 shadow' : 'bg-gray-50 border-gray-200'}">
                                        <p class="text-4xl font-black text-green-600">${a.btts.ggProbability.toFixed(0)}%</p>
                                        <p class="font-bold text-gray-700">GG</p>
                                    </div>
                                    <div class="rounded-xl p-4 text-center border-2 ${a.btts.prediction === 'NG' ? 'bg-red-50 border-red-400 shadow' : 'bg-gray-50 border-gray-200'}">
                                        <p class="text-4xl font-black text-red-600">${a.btts.ngProbability.toFixed(0)}%</p>
                                        <p class="font-bold text-gray-700">NG</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 mb-4">
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">${homeName} segna</span>
                                            <span class="font-bold">${a.btts.homeScoringProb.toFixed(0)}%</span>
                                        </div>
                                        ${probBar(a.btts.homeScoringProb, 'green')}
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">${awayName} segna</span>
                                            <span class="font-bold">${a.btts.awayScoringProb.toFixed(0)}%</span>
                                        </div>
                                        ${probBar(a.btts.awayScoringProb, 'red')}
                                    </div>
                                </div>
                                
                                <div class="rounded-xl p-4 border-2 ${a.btts.prediction === 'GG' ? 'bg-green-50 border-green-400' : 'bg-red-50 border-red-400'} flex justify-between items-center">
                                    <div>
                                        <p class="text-xs text-gray-500">PRONOSTICO</p>
                                        <p class="text-2xl font-black">${a.btts.prediction}</p>
                                    </div>
                                    ${badge(a.btts.confidence, 'full')}
                                </div>
                            </div>
                        </div>

                        <!-- OVER 2.5 -->
                        <div class="bg-white rounded-2xl shadow-md mb-4 overflow-hidden">
                            <div class="px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-500">
                                <h3 class="font-bold text-white">üîÆ Over / Under</h3>
                            </div>
                            <div class="p-4">
                                <div class="space-y-2 mb-4">
                                    ${a.goals.predictions.map(p => `
                                        <div class="flex items-center justify-between px-4 py-3 rounded-xl ${p.line === 2.5 ? 'bg-purple-50 border-2 border-purple-300' : 'bg-gray-50'}">
                                            <div>
                                                <span class="font-bold text-gray-800">${p.prediction} ${p.line}</span>
                                                <span class="text-gray-500 text-sm ml-2">(${p.probability.toFixed(0)}%)</span>
                                            </div>
                                            ${badge(50 + Math.abs(p.probability - 50) * 0.6)}
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="rounded-xl p-4 border-2 ${a.goals.mainPrediction.includes('OVER') ? 'bg-purple-50 border-purple-400' : 'bg-gray-100 border-gray-300'} flex justify-between items-center">
                                    <div>
                                        <p class="text-xs text-gray-500">PRONOSTICO</p>
                                        <p class="text-2xl font-black">${a.goals.mainPrediction}</p>
                                    </div>
                                    ${badge(a.goals.confidence, 'full')}
                                </div>
                            </div>
                        </div>

                        <!-- CORNER -->
                        <div class="bg-white rounded-2xl shadow-md mb-4 overflow-hidden">
                            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-cyan-500">
                                <h3 class="font-bold text-white">üö© Corner Totali</h3>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                                    <div class="bg-blue-50 rounded-xl p-3">
                                        <p class="text-xs text-blue-600">${homeName}</p>
                                        <p class="text-2xl font-black text-blue-700">${a.corners.homeExpected.toFixed(1)}</p>
                                    </div>
                                    <div class="bg-blue-100 rounded-xl p-3">
                                        <p class="text-xs text-blue-700">TOTALE</p>
                                        <p class="text-2xl font-black text-blue-800">${a.corners.totalExpected.toFixed(1)}</p>
                                    </div>
                                    <div class="bg-blue-50 rounded-xl p-3">
                                        <p class="text-xs text-blue-600">${awayName}</p>
                                        <p class="text-2xl font-black text-blue-700">${a.corners.awayExpected.toFixed(1)}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 mb-4">
                                    ${a.corners.predictions.map(p => `
                                        <div class="flex items-center justify-between px-4 py-2.5 rounded-xl ${p === a.corners.bestBet ? 'bg-green-50 border-2 border-green-400' : 'bg-gray-50'}">
                                            <span class="font-medium text-gray-800">${p === a.corners.bestBet ? '‚≠ê ' : ''}${p.prediction} ${p.line}</span>
                                            ${badge(p.confidence)}
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="bg-green-50 border-2 border-green-400 rounded-xl p-4 flex justify-between items-center">
                                    <div>
                                        <p class="text-xs text-gray-500">BEST BET</p>
                                        <p class="text-2xl font-black text-green-700">${a.corners.bestBet.prediction} ${a.corners.bestBet.line}</p>
                                    </div>
                                    ${badge(a.corners.bestBet.confidence, 'full')}
                                </div>
                            </div>
                        </div>

                        <!-- CARDS -->
                        <div class="bg-white rounded-2xl shadow-md mb-4 overflow-hidden">
                            <div class="px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500">
                                <h3 class="font-bold text-white">üü® Cartellini Totali</h3>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                                    <div class="bg-amber-50 rounded-xl p-3">
                                        <p class="text-xs text-amber-600">${homeName}</p>
                                        <p class="text-2xl font-black text-amber-700">${a.cards.homeExpected.toFixed(1)}</p>
                                    </div>
                                    <div class="bg-amber-100 rounded-xl p-3">
                                        <p class="text-xs text-amber-700">TOTALE</p>
                                        <p class="text-2xl font-black text-amber-800">${a.cards.totalExpected.toFixed(1)}</p>
                                    </div>
                                    <div class="bg-amber-50 rounded-xl p-3">
                                        <p class="text-xs text-amber-600">${awayName}</p>
                                        <p class="text-2xl font-black text-amber-700">${a.cards.awayExpected.toFixed(1)}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 mb-4">
                                    ${a.cards.predictions.map(p => `
                                        <div class="flex items-center justify-between px-4 py-2.5 rounded-xl ${p === a.cards.bestBet ? 'bg-green-50 border-2 border-green-400' : 'bg-gray-50'}">
                                            <span class="font-medium text-gray-800">${p === a.cards.bestBet ? '‚≠ê ' : ''}${p.prediction} ${p.line}</span>
                                            ${badge(p.confidence)}
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="bg-green-50 border-2 border-green-400 rounded-xl p-4 flex justify-between items-center">
                                    <div>
                                        <p class="text-xs text-gray-500">BEST BET</p>
                                        <p class="text-2xl font-black text-green-700">${a.cards.bestBet.prediction} ${a.cards.bestBet.line}</p>
                                    </div>
                                    ${badge(a.cards.bestBet.confidence, 'full')}
                                </div>
                            </div>
                        </div>

                        <!-- SUMMARY -->
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-2xl p-5 text-white shadow-xl">
                            <h3 class="font-bold text-center text-lg mb-4">üèÜ PRONOSTICI FINALI</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                                    <p class="text-white/60 text-xs mb-1">GG/NG</p>
                                    <p class="text-3xl font-black">${a.btts.prediction}</p>
                                    <p class="text-green-400 text-sm font-medium">${a.btts.confidence.toFixed(0)}%</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                                    <p class="text-white/60 text-xs mb-1">GOAL</p>
                                    <p class="text-3xl font-black">${a.goals.mainPrediction.replace('OVER ', 'O').replace('UNDER ', 'U')}</p>
                                    <p class="text-purple-400 text-sm font-medium">${a.goals.confidence.toFixed(0)}%</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                                    <p class="text-white/60 text-xs mb-1">CORNER</p>
                                    <p class="text-3xl font-black">${a.corners.bestBet.prediction.charAt(0)} ${a.corners.bestBet.line}</p>
                                    <p class="text-blue-400 text-sm font-medium">${a.corners.bestBet.confidence.toFixed(0)}%</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                                    <p class="text-white/60 text-xs mb-1">CARDS</p>
                                    <p class="text-3xl font-black">${a.cards.bestBet.prediction.charAt(0)} ${a.cards.bestBet.line}</p>
                                    <p class="text-amber-400 text-sm font-medium">${a.cards.bestBet.confidence.toFixed(0)}%</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            root.innerHTML = `
                <div class="max-w-lg mx-auto min-h-screen flex flex-col">
                    <header class="bg-white shadow-md sticky top-0 z-40">
                        <div class="px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-3xl">üéØ</span>
                                <div>
                                    <h1 class="font-black text-gray-900">ULTIMATE</h1>
                                    <p class="text-xs text-green-600 font-medium">AI Betting Predictor</p>
                                </div>
                            </div>
                            <select onchange="changeLeague(this.value)" class="px-3 py-2 bg-gray-100 rounded-xl text-sm font-bold focus:ring-2 focus:ring-green-500">
                                ${Object.entries(LEAGUE_DATA).map(([code, l]) => `
                                    <option value="${code}" ${code === state.selectedLeague ? 'selected' : ''}>${l.flag} ${l.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="flex">
                            <button onclick="setTab('matches')" class="flex-1 py-3 text-sm font-bold border-b-3 transition-all ${state.activeTab === 'matches' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500'}">
                                üìÖ Partite
                            </button>
                            <button onclick="setTab('analysis')" class="flex-1 py-3 text-sm font-bold border-b-3 transition-all ${state.activeTab === 'analysis' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500'}">
                                üéØ Analisi
                            </button>
                        </div>
                    </header>
                    <main class="flex-1 p-4 pb-20">${content}</main>
                    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex justify-between items-center text-xs text-gray-500 max-w-lg mx-auto">
                        <span>üß† Poisson + xG + Correlations</span>
                        <button onclick="resetApp()" class="text-red-500 font-medium">Reset</button>
                    </footer>
                </div>
            `;
        }

        render();
        if (state.apiKey && !state.showSetup) loadMatches();
    </script>
</body>
</html>
